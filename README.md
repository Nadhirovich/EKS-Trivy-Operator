# Start EKS Cluster and Scan with Trivy and List the Vulnerability Report Results

This workflow automates the process of creating an Amazon EKS (Elastic Kubernetes Service) cluster, deploying a vulnerable application, scanning it for vulnerabilities using [Trivy Operator](https://aquasecurity.github.io/trivy-operator/), and then listing and saving the generated vulnerability reports. Finally, it cleans up by destroying the EKS cluster.

**Why is Trivy Operator useful?**

In dynamic Kubernetes environments, security threats can emerge rapidly. Trivy Operator helps you proactively identify and address these risks by:

* **Automated Scanning:** It automatically scans your Kubernetes resources (e.g., Deployments, Pods, ReplicaSets, etc.) for vulnerabilities without requiring manual intervention.
* **Comprehensive Vulnerability Detection:** Trivy Operator detects a wide range of security issues, including:
    * Container image vulnerabilities (OS packages, language-specific dependencies)
    * Kubernetes configuration issues (using OPA Rego policies)
    * Secrets exposed in your Kubernetes manifests
    * RBAC misconfigurations
* **Actionable Reporting:** It generates detailed reports on the identified vulnerabilities, including severity levels, affected resources, and remediation advice.
* **Integration with Kubernetes:** Being Kubernetes-native, it seamlessly integrates with your existing Kubernetes tools and workflows.

**How it works:**

Trivy Operator runs as a set of Kubernetes controllers within your cluster. It works by:

1.  **Discovering Resources:** It continuously watches for new and updated Kubernetes resources.
2.  **Scanning Resources:** When a relevant resource is detected, Trivy Operator triggers a scan using the Trivy CLI. The scan results are stored as Kubernetes custom resources (CRs).
3.  **Generating Reports:** Based on the scan results, Trivy Operator creates detailed vulnerability reports as CRs associated with the scanned resources.
4.  **Providing Insights:** You can then query these custom resources using `kubectl` or integrate with other security tools to view and act upon the findings.

**This GitHub Actions workflow specifically:**

1.  **Provisions an EKS Cluster:** It creates a managed Kubernetes cluster on AWS using `eksctl`.
2.  **Deploys a Vulnerable Application:** It deploys an `nginx:1.16` container, which is known to have vulnerabilities, to the newly created cluster.
3.  **Installs Trivy Operator:** It deploys Trivy Operator into the EKS cluster using Helm.
4.  **Fetches and Lists Vulnerability Reports:** It retrieves the vulnerability reports generated by Trivy Operator for all namespaces and provides a detailed output in YAML format.
5.  **Saves Vulnerability Reports as an Artifact:** It saves the vulnerability reports in JSON format as a downloadable artifact for further analysis.
6.  **Destroys the EKS Cluster:** Finally, it cleans up the AWS resources by deleting the created EKS cluster.

## Workflow Details

This workflow is triggered on any push to the `master` branch, except for changes in Markdown (`.md`) files.

### Jobs

The workflow consists of the following jobs:

1.  **`create-eks-cluster`**:
    * Sets up AWS credentials.
    * Installs `eksctl`.
    * Creates an EKS cluster named `my-eks-cluster` in the `eu-central-1` region with a managed node group.

    ```yaml
    - name: Create EKS Cluster
      run: |
        eksctl create cluster \
          --name my-eks-cluster \
          --region eu-central-1 \
          --nodegroup-name standard-workers \
          --node-type t3.medium \
          --nodes 2 \
          --nodes-min 1 \
          --nodes-max 3 \
          --managed
    ```

2.  **`deploy-vulnerable-application`**:
    * Requires the `create-eks-cluster` job to complete successfully.
    * Sets up AWS credentials.
    * Installs `kubectl`.
    * Sets up the `kubeconfig` to interact with the created EKS cluster.
    * Verifies the connection to the Kubernetes cluster.
    * Deploys an `nginx:1.16` deployment named `nginx` in the default namespace.

    ```yaml
    - name: Deploy Vulnerable Application
      run: |
        cat <<EOF | kubectl apply -f -
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: nginx
          labels:
            app: nginx
        spec:
          replicas: 1
          selector:
            matchLabels:
              app: nginx
          template:
            metadata:
              labels:
                app: nginx
            spec:
              containers:
              - name: nginx
                image: nginx:1.16
                ports:
                - containerPort: 80
        EOF
    ```

3.  **`deploy-trivy-operator`**:
    * Requires the `deploy-vulnerable-application` job to complete successfully.
    * Sets up AWS credentials.
    * Sets up the `kubeconfig`.
    * Installs Helm.
    * Adds the Aqua Security Helm repository.
    * Updates the Helm repositories.
    * Installs Trivy Operator in the `trivy-system` namespace.

    ```yaml
    - name: Deploy Trivy Operator
      run: |
        helm repo add aqua [https://aquasecurity.github.io/helm-charts/](https://aquasecurity.github.io/helm-charts/)
        helm repo update
        helm install trivy-operator aqua/trivy-operator --namespace trivy-system --create-namespace
    ```

4.  **`fetch-scan-reports`**:
    * Requires the `deploy-trivy-operator` job to complete successfully.
    * Sets up AWS credentials.
    * Sets up the `kubeconfig`.
    * Verifies the connection to the Kubernetes cluster.
    * Fetches and lists all vulnerability reports in all namespaces.
    * Lists the vulnerability reports in detail (YAML format).
    * Saves the vulnerability reports in JSON format to `vulnerability-reports.json`.
    * Uploads the `vulnerability-reports.json` file as an artifact named `vulnerability-reports`.

    ```yaml
    - name: Fetch Vulnerability Reports
      run: |
        kubectl get vulnerabilityreports -A

    - name: List Vulnerability Reports (Detailed)
      run: |
        echo "Listing Vulnerability Reports:"
        kubectl get vulnerabilityreports -A -o yaml

    - name: Save Reports
      run: |
        kubectl get vulnerabilityreports -A -o json > vulnerability-reports.json
    - name: Upload Vulnerability Report
      uses: actions/upload-artifact@v4
      with:
        name: vulnerability-reports
        path: vulnerability-reports.json
    ```

5.  **`destroy-cluster`**:
    * Requires the `fetch-scan-reports` job to complete successfully.
    * Sets up AWS credentials.
    * Installs `eksctl`.
    * Deletes the EKS cluster named `my-eks-cluster` in the `eu-central-1` region.

    ```yaml
    - name: Delete EKS Cluster
      run: |
        eksctl delete cluster --name my-eks-cluster --region eu-central-1
    ```

**Note:** This workflow requires you to have your AWS access key ID and secret access key configured as GitHub secrets (`AWS_ACCESS_KEY_ID` and `AWS_SECRET_ACCESS_KEY`) in your repository settings.

This workflow provides an automated way to quickly spin up an EKS cluster, deploy a vulnerable application, scan it using Trivy Operator, and retrieve the security findings, making it a valuable tool for security testing and demonstrations.
